<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">






















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.1.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.2">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.1.2',
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="说我能做的，做我说过的">
<meta property="og:type" content="website">
<meta property="og:title" content="黄帅的博客">
<meta property="og:url" content="https://huangshuai-iot.github.io/index.html">
<meta property="og:site_name" content="黄帅的博客">
<meta property="og:description" content="说我能做的，做我说过的">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="黄帅的博客">
<meta name="twitter:description" content="说我能做的，做我说过的">





  
  
  <link rel="canonical" href="https://huangshuai-iot.github.io/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>黄帅的博客</title>
  






  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?de241358bbb90d3e97f1f8486e6d5b41";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>







  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">黄帅的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-schedule">

    
    
      
    

    

    <a href="/schedule/" rel="section"><i class="menu-item-icon fa fa-fw fa-calendar"></i> <br>Schedule</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-sitemap">

    
    
      
    

    

    <a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>Sitemap</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-commonweal">

    
    
      
    

    

    <a href="/404/" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>Commonweal 404</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huangshuai-iot.github.io/2017/12/09/2017-12-09-Supervisor使用入门/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄帅">
      <meta itemprop="description" content="说我能做的，做我说过的">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄帅的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/12/09/2017-12-09-Supervisor使用入门/" class="post-title-link" itemprop="url">Supervisor使用入门</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-12-09 19:43:53" itemprop="dateCreated datePublished" datetime="2017-12-09T19:43:53+08:00">2017-12-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-17 23:13:17" itemprop="dateModified" datetime="2019-06-17T23:13:17+08:00">2019-06-17</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Server/" itemprop="url" rel="index"><span itemprop="name">Server</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Server/Tools/" itemprop="url" rel="index"><span itemprop="name">Tools</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>之前写的一个TCP Server最近部署到生产环境，Server用的Python的Twisted框架，里面虽然有进程守护的功能，但是我之前一直用的Supervisor做后台进程管理，其比较好的是具有一个Web管理界面，可以可视化的控制后台进程的启停，我比较喜欢。</p>
<h2 id="安装Supervisor"><a href="#安装Supervisor" class="headerlink" title="安装Supervisor"></a>安装Supervisor</h2><p>由于Supervisor是用python2开发，于是在服务器里就开了一个新的Python虚拟环境，安装了python2.7。直接 <code>pip install supervisor</code> 就好。</p>
<h2 id="配置Supervisor"><a href="#配置Supervisor" class="headerlink" title="配置Supervisor"></a>配置Supervisor</h2><h3 id="基本配置"><a href="#基本配置" class="headerlink" title="基本配置"></a>基本配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 生成配置文件</span><br><span class="line">echo_supervisord_conf &gt; /etc/supervisord.conf</span><br><span class="line"></span><br><span class="line"># 生成后台进程配置文件文件夹</span><br><span class="line">mkdir /etc/supervisord.d/</span><br><span class="line"></span><br><span class="line"># 修改配置文件：</span><br><span class="line">vi /etc/supervisord.conf</span><br><span class="line">	</span><br><span class="line"># 在文件最后添上以下命令，意思包括上面文件夹里的配置文件</span><br><span class="line">[include]</span><br><span class="line">files = /etc/supervisord.d/*.conf</span><br></pre></td></tr></table></figure>

<h3 id="配置Web远程控制"><a href="#配置Web远程控制" class="headerlink" title="配置Web远程控制"></a>配置Web远程控制</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 修改配置文件</span><br><span class="line">vi /etc/supervisord.conf</span><br><span class="line"></span><br><span class="line"># 把以下内容取消注释，建议把这三个都改调，防止端口被扫描</span><br><span class="line">[inet_http_server]         ; inet (TCP) server disabled by default</span><br><span class="line">port=0.0.0.0:9001        ; ip_address:port specifier, *:port for all iface</span><br><span class="line">username=user              ; default is no username (open server)</span><br><span class="line">password=123               ; default is no password (open server)</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>  要想外网访问，还得记得在阿里云的安全组设置里打开对应的端口</p>
<h3 id="配置Supervisor为Service"><a href="#配置Supervisor为Service" class="headerlink" title="配置Supervisor为Service"></a>配置Supervisor为Service</h3><ol>
<li><p>查看好python2.7的路径</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">which python2.7</span><br><span class="line">/usr/local/bin/python2.7</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加service启动脚本,将python路径换成上文的路径</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/init.d/</span><br><span class="line">vi supervisord</span><br></pre></td></tr></table></figure>

<p> 将以下内容添加进去</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">#</span><br><span class="line"># /etc/init.d/supervisord</span><br><span class="line">#</span><br><span class="line"># Supervisor is a client/server system that</span><br><span class="line"># allows its users to monitor and control a</span><br><span class="line"># number of processes on UNIX-like operating</span><br><span class="line"># systems.</span><br><span class="line">#</span><br><span class="line"># chkconfig: - 64 36</span><br><span class="line"># description: Supervisor Server</span><br><span class="line"># processname: supervisord</span><br><span class="line"> </span><br><span class="line"># Source init functions</span><br><span class="line">. /etc/rc.d/init.d/functions</span><br><span class="line"> </span><br><span class="line">prog=&quot;supervisord&quot;</span><br><span class="line"> </span><br><span class="line">prefix=&quot;/usr/local&quot;</span><br><span class="line">exec_prefix=&quot;$&#123;prefix&#125;&quot;</span><br><span class="line">prog_bin=&quot;$&#123;exec_prefix&#125;/bin/supervisord&quot;</span><br><span class="line">PIDFILE=&quot;/var/run/$prog.pid&quot;</span><br><span class="line"> </span><br><span class="line">start()</span><br><span class="line">&#123;</span><br><span class="line">       echo -n $&quot;Starting $prog: &quot;</span><br><span class="line">       ###注意下面这一行一定得有-c /etc/supervisord.conf   不然修改了配置文件根本不生效！</span><br><span class="line">       daemon $prog_bin -c /etc/supervisord.conf --pidfile $PIDFILE</span><br><span class="line">       [ -f $PIDFILE ] &amp;&amp; success $&quot;$prog startup&quot; || failure $&quot;$prog startup&quot;</span><br><span class="line">       echo</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">stop()</span><br><span class="line">&#123;</span><br><span class="line">       echo -n $&quot;Shutting down $prog: &quot;</span><br><span class="line">       [ -f $PIDFILE ] &amp;&amp; killproc $prog || success $&quot;$prog shutdown&quot;</span><br><span class="line">       echo</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">case &quot;$1&quot; in</span><br><span class="line"> </span><br><span class="line"> start)</span><br><span class="line">   start</span><br><span class="line"> ;;</span><br><span class="line"> </span><br><span class="line"> stop)</span><br><span class="line">   stop</span><br><span class="line"> ;;</span><br><span class="line"> </span><br><span class="line"> status)</span><br><span class="line">       status $prog</span><br><span class="line"> ;;</span><br><span class="line"> </span><br><span class="line"> restart)</span><br><span class="line">   stop</span><br><span class="line">   start</span><br><span class="line"> ;;</span><br><span class="line"> </span><br><span class="line"> *)</span><br><span class="line">   echo &quot;Usage: $0 &#123;start|stop|restart|status&#125;&quot;</span><br><span class="line"> ;;</span><br><span class="line"> </span><br><span class="line">esac</span><br></pre></td></tr></table></figure>
</li>
<li><p>把启动脚本加入service启动项</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /etc/init.d/supervisord</span><br><span class="line">chkconfig --add supervisord</span><br><span class="line">chkconfig supervisord on</span><br><span class="line">service supervisord start</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="配置要管理的进程"><a href="#配置要管理的进程" class="headerlink" title="配置要管理的进程"></a>配置要管理的进程</h2><p>在管理目录下新建配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/supervisord.d/</span><br><span class="line">vi xxx.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[program:xxx]</span><br><span class="line">command=/usr/local/python3/bin/python3  /root/xxx.py</span><br><span class="line">autostart=true                           ;是否随supervisor启动</span><br><span class="line">autorestart=true                         ;是否在挂了之后重启，意外关闭后会重启，比如kill掉！</span><br><span class="line">startretries=3                           ;启动尝试次数</span><br><span class="line">stderr_logfile=/tmp/pileSocketServer.err.log        ;标准输出的位置</span><br><span class="line">stdout_logfile=/tmp/pileSocketServer.out.log        ;标准错误输出的位置</span><br></pre></td></tr></table></figure>

<p>这里更多的配置参数详见<a href="http://supervisord.org/configuration.html#program-x-section-values" target="_blank" rel="noopener">Supervisor官网参数配置页</a></p>
<p>添加完配置文件后，重启Supervisor服务<code>service supervisord restart</code>就大功告成了。</p>
<p>注：我在实测中，虽然调用restart显示成功，但是Supervisor并没有启动成功。测试以后发现，我的环境需要Start两次才能成功，因此我每次重启Supervisor，只能stop-&gt;start-&gt;start.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service supervisord stop</span><br><span class="line">service supervisord start</span><br><span class="line">service supervisord start</span><br></pre></td></tr></table></figure>

<h2 id="番外"><a href="#番外" class="headerlink" title="番外"></a>番外</h2><p>这个项目是暑期写的，这次回过头来看，重构的时候发现有些业务逻辑都忘了，因此感叹文档记录太重要了。</p>
<p>有了记录文档，以后就算忘了回过头来看也可以更快恢复上下文。</p>
<p>说这些就是提醒自己，笔记和博客都得勤记。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://blog.51cto.com/youerning/1714627" target="_blank" rel="noopener">Centos平台Supervisord全攻略</a></li>
<li><a href="http://supervisord.org/configuration.html" target="_blank" rel="noopener">Supervisor官网文档</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huangshuai-iot.github.io/2017/11/24/2017-11-24-ARKit入门-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄帅">
      <meta itemprop="description" content="说我能做的，做我说过的">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄帅的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/11/24/2017-11-24-ARKit入门-1/" class="post-title-link" itemprop="url">ARKit入门-在AR中处理3D交互和UI控制</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-11-24 20:05:19" itemprop="dateCreated datePublished" datetime="2017-11-24T20:05:19+08:00">2017-11-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-17 23:13:17" itemprop="dateModified" datetime="2019-06-17T23:13:17+08:00">2019-06-17</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/ARKit/" itemprop="url" rel="index"><span itemprop="name">ARKit</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/ARKit/翻译/" itemprop="url" rel="index"><span itemprop="name">翻译</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>翻译自 <a href="https://developer.apple.com/documentation/arkit/handling_3d_interaction_and_ui_controls_in_augmented_reality" target="_blank" rel="noopener">Handling 3D Interaction and UI Controls in Augmented Reality</a></p>
</blockquote>
<p>遵循AR体验中的视觉反馈、手势交互和现实渲染的最佳实践。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>AR为用户提供了在app中与现实和虚拟3D内容交互的新方法。但是，人机界面设计的许多基本原理仍然有效。令人信服的AR幻想同样需要仔细关注3D资源和渲染。iOS人机界面指南包含有关AR人机界面原则的建议。该项目展示了如何应用这些指导方法轻松地创建身临其境、直观的AR体验。</p>
<p>这个示例app提供了一个简单的AR体验，允许用户将一个或多个真实的虚拟对象放置在现实世界的环境中，然后试用直观的手势来排列这些对象。该app提供了用户界面提示，以帮助用户了解AR体验的状态以及交互选项。</p>
<p>以下各节对应于 <a href="https://developer.apple.com/ios/human-interface-guidelines/technologies/augmented-reality/" target="_blank" rel="noopener">iOS人机交互指南&gt;AR</a> 中的各个部分，并提供有关该示例app如何实现这些指南的详细信息。有关每个部分的更详细的推理，请参阅iOS人机界面的指南的相应部分。</p>
<h2 id="放置虚拟对象"><a href="#放置虚拟对象" class="headerlink" title="放置虚拟对象"></a>放置虚拟对象</h2><p>帮助人们了解何时定位平面和放置虚拟对象。FocusSquare 类在AR View中绘制方形轮廓，为用户提供有关 ARKit 世界跟踪状态的提示。</p>
<p><img src="https://docs-assets.developer.apple.com/published/d43e250ee6/de02235f-216c-4d3f-8730-e3d433163b62.png" alt="Demo"></p>
<p>正方形改变大小和方向以反映估计的场景深度，并以动效形式在打开和关闭状态间切换，以指示ARKit是否检测到适合放置虚拟对象的平面。在用户放置虚拟对象后，焦点正方形小时，保持隐藏状态，直到用户将相机指向另一个表面。</p>
<p><strong>当用户放置一个虚拟对象时要做出适当的响应</strong>。当用户选择要放置的虚拟对象时，示例app的 setPosition(_:relativeTo:smoothMovement) 方法使用 FocusSquare 对象的简单启发式方法将虚拟对象放置于屏幕中间的大致现实的位置，即使ARKit没有在那个地方发现一个平面。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">guard</span> <span class="keyword">let</span> cameraTransform = session.currentFrame?.camera.transform,</span><br><span class="line">    <span class="keyword">let</span> focusSquarePosition = focusSquare.lastPosition <span class="keyword">else</span> &#123;</span><br><span class="line">    statusViewController.showMessage(<span class="string">"CANNOT PLACE OBJECT\nTry moving left or right."</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">        </span><br><span class="line">virtualObjectInteraction.selectedObject = virtualObject</span><br><span class="line">virtualObject.setPosition(focusSquarePosition, relativeTo: cameraTransform, smoothMovement: <span class="literal">false</span>)</span><br><span class="line">        </span><br><span class="line">updateQueue.async &#123;</span><br><span class="line">    <span class="keyword">self</span>.sceneView.scene.rootNode.addChildNode(virtualObject)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个位置可能不是用户想要放置虚拟对象的真实世界表面的精确估计，但它足够接近，以快速地将物体添加到屏幕上。</p>
<p>随着时间的推移，ARKit 会检测平面并提高其位置的估计值，调用 <a href="https://developer.apple.com/documentation/arkit/arscnviewdelegate/2865794-renderer" target="_blank" rel="noopener">renderer(_:didAdd:for:)</a> 和 <a href="https://developer.apple.com/documentation/arkit/arscnviewdelegate/2865799-renderer" target="_blank" rel="noopener">renderer(_:didUpdate:for:)</a> 委托方法来报告结果。在这些方法中，示例app调用其 <code>adjustOntoPlaneAnchor(_:using:)</code> 方法来确定之前放置的虚拟对象是否靠近检测到的平面。如果靠近，该方法使用微妙的动画将虚拟对象移动到检测到的平面上，受益于ARKit在该位置对现实世界表面的精确估计，是虚拟对象看起来在用户选择的位置：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Move onto the plane if it is near it (within 5 centimeters).</span></span><br><span class="line"><span class="keyword">let</span> verticalAllowance: <span class="type">Float</span> = <span class="number">0.05</span></span><br><span class="line"><span class="keyword">let</span> epsilon: <span class="type">Float</span> = <span class="number">0.001</span> <span class="comment">// Do not update if the difference is less than 1 mm.</span></span><br><span class="line"><span class="keyword">let</span> distanceToPlane = <span class="built_in">abs</span>(planePosition.y)</span><br><span class="line"><span class="keyword">if</span> distanceToPlane &gt; epsilon &amp;&amp; distanceToPlane &lt; verticalAllowance &#123;</span><br><span class="line">    <span class="type">SCNTransaction</span>.begin()</span><br><span class="line">    <span class="type">SCNTransaction</span>.animationDuration = <span class="type">CFTimeInterval</span>(distanceToPlane * <span class="number">500</span>) <span class="comment">// Move 2 mm per second.</span></span><br><span class="line">    <span class="type">SCNTransaction</span>.animationTimingFunction = <span class="type">CAMediaTimingFunction</span>(name: kCAMediaTimingFunctionEaseInEaseOut)</span><br><span class="line">    position.y = anchor.transform.columns.<span class="number">3</span>.y</span><br><span class="line">    <span class="type">SCNTransaction</span>.commit()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="用户与虚拟对象的交互"><a href="#用户与虚拟对象的交互" class="headerlink" title="用户与虚拟对象的交互"></a>用户与虚拟对象的交互</h2><p><strong>允许用户使用标准的、熟悉的手势与虚拟对象直接进行交互。</strong>该示例app使用单指轻拍，单/双指平移，双指旋转手势识别，以使用户放置和旋转虚拟对象。示例app的代码中 <code>VirtualObjectInteraction</code> 类管理这些手势。</p>
<p><strong>一般来说，要保持交互简单。</strong>当拖动一个虚拟对象时（参见 <code>translate(_:basedOn:infinitePlane:)</code> 方法），示例app将虚拟对象的移动限制在它被放置的二维平面上。类似的，由于虚拟对象停留在水平面上，旋转手势（参见 <code>didRotate(_:)</code> 方法）只能绕着垂直轴来旋转对象，以使得对象保持在平面上。</p>
<p><strong>在合理接近交互式虚拟对象时对用户手势做出响应。</strong>示例代码的 <code>objectInteracting(with:in:)</code> 方法使用手势识别器提供的触摸位置执行hit测试。通过针对虚拟对象边界框进行hit测试，该方法使得即使用户触摸位置不在虚拟对象的可见内容的点上，用户触摸也有可能影响虚拟对象。通过对多点触摸手势执行多个hit测试，该方法使得用户触摸更有可能影响预期的对象：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> index <span class="keyword">in</span> <span class="number">0</span>..&lt;gesture.numberOfTouches &#123;</span><br><span class="line">    <span class="keyword">let</span> touchLocation = gesture.location(ofTouch: index, <span class="keyword">in</span>: view)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Look for an object directly under the `touchLocation`.</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> object = sceneView.virtualObject(at: touchLocation) &#123;</span><br><span class="line">        <span class="keyword">return</span> object</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">        </span><br><span class="line"><span class="comment">// As a last resort look for an object under the center of the touches.</span></span><br><span class="line"><span class="keyword">return</span> sceneView.virtualObject(at: gesture.center(<span class="keyword">in</span>: view))</span><br></pre></td></tr></table></figure>

<p><strong>考虑用户启动的对象缩放是否必要。</strong> 这个AR app放置了可能自然出现在用户真实环境中的逼真虚拟对象，因此保留虚拟对象的固有尺寸有助于保持真实感。因此，该app没有添加手势或者其他UI来启用虚拟对象缩放。此外，通过不使用缩放手势，示例app防止用户对手势调整虚拟对象大小 或 改变虚拟对象与相机的距离 产生困惑。（如果你选择再app中启动虚拟对象缩放，请使用pinch捏合手势。）</p>
<p><strong>警惕潜在的冲突手势。</strong>示例app的 <code>ThresholdPanGesture</code> 类是一个 <a href="https://developer.apple.com/documentation/uikit/uipangesturerecognizer" target="_blank" rel="noopener">UIPanGestureRecognizer</a> 子类，它提供了一种方法，延迟手势识别器效果，直到手势正在进行通过指定的移动阈值。示例app的<code>touchesMoved(with:)</code> 方法使用该类来让用户在单指拖动虚拟对象手势和双指旋转对象手势间平滑过渡：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">touchesMoved</span><span class="params">(<span class="number">_</span> touches: Set&lt;UITouch&gt;, with event: UIEvent)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.touchesMoved(touches, with: event)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> translationMagnitude = translation(<span class="keyword">in</span>: view).length</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Adjust the threshold based on the number of touches being used.</span></span><br><span class="line">    <span class="keyword">let</span> threshold = <span class="type">ThresholdPanGesture</span>.threshold(forTouchCount: touches.<span class="built_in">count</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> !isThresholdExceeded &amp;&amp; translationMagnitude &gt; threshold &#123;</span><br><span class="line">        isThresholdExceeded = <span class="literal">true</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Set the overall translation to zero as the gesture should now begin.</span></span><br><span class="line">        setTranslation(.zero, <span class="keyword">in</span>: view)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>确保虚拟对象的移动平稳。</strong>示例app的 <code>setPosition(_:relativeTo:smoothMovement)</code> 方法在触摸手势引起的拖动虚拟对象位置 和 该对象近期位置之间插值。通过平均 基于相机距离的近期位置，该方法产生平滑的拖动移动，而不会使 被拖动物体滞后于用户的手势：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> smoothMovement &#123;</span><br><span class="line">    <span class="keyword">let</span> hitTestResultDistance = simd_length(positionOffsetFromCamera)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Add the latest position and keep up to 10 recent distances to smooth with.</span></span><br><span class="line">    recentVirtualObjectDistances.append(hitTestResultDistance)</span><br><span class="line">    recentVirtualObjectDistances = <span class="type">Array</span>(recentVirtualObjectDistances.suffix(<span class="number">10</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> averageDistance = recentVirtualObjectDistances.average!</span><br><span class="line">    <span class="keyword">let</span> averagedDistancePosition = simd_normalize(positionOffsetFromCamera) * averageDistance</span><br><span class="line">    simdPosition = cameraWorldPosition + averagedDistancePosition</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    simdPosition = cameraWorldPosition + positionOffsetFromCamera</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>探索更吸引用户的交互方法。</strong>在AR体验中，pan平移手势（将手指移动到设备的屏幕上）并不是将虚拟对象拖动到新位置的唯一自然方式。用户也可以在移动设备时直观地将手指一直放置在虚拟对象上，从而将虚拟对象拖到AR场景中的新位置。</p>
<p>即使手势在屏幕上的触摸位置没有改变，示例app也通过在拖动手势时不断的调用其 <code>updateObjectToCurrentTrackingPosition()</code> 方法来支持这种手势。若设备在拖动过程中发生移动，则该方法会计算其对应于触摸位置的新的现实位置，并相应地移动虚拟对象。</p>
<h2 id="进入AR"><a href="#进入AR" class="headerlink" title="进入AR"></a>进入AR</h2><p><strong>指示用户何时进行初始化。</strong>该示例app通过文本提示显示有关AR session状态，通过浮动的文本视图显示与AR进行交互的说明。示例app的 <code>StatusViewController</code> 类管理此视图，可显示短暂的说明，该说明允许用户在读取它们之后消失，或显示始终保持可见的重要状态信息直至用户纠正问题。</p>
<p><img src="https://docs-assets.developer.apple.com/published/f385e426f2/d665844f-2945-44f9-9896-06a1bb53251a.png" alt="image"></p>
<h2 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h2><p><strong>如果不符合用户的期望可以重置。</strong>示例app具有一个始终在UI界面右上角的Reset重置按钮，允许用户重启AR体验不管其状态如何。参见示例代码的 <code>restartExperience()</code> 方法。</p>
<p><strong>仅在支持的设备上提供AR功能</strong>。示例App的核心功能需要使用ARKit，因此它在Info.plist文件的 <a href="https://developer.apple.com/library/content/documentation/General/Reference/InfoPlistKeyReference/Articles/iPhoneOSKeys.html#//apple_ref/doc/uid/TP40009252-SW3" target="_blank" rel="noopener">UIRequiredDeviceCapabilities</a> 部分定义了 arkit 键。在部署构建的项目时，该键的设置可以防止在不支持ARKit的设备上安装。</p>
<p>如果你的应用把ARKit作为辅助功能，请使用 <a href="https://developer.apple.com/documentation/arkit/arconfiguration/2923553-issupported" target="_blank" rel="noopener">isSupported</a> 方法确定是否需要隐藏 ARKit 功能。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huangshuai-iot.github.io/2017/11/24/2017-11-24-ARKit入门-0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄帅">
      <meta itemprop="description" content="说我能做的，做我说过的">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄帅的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/11/24/2017-11-24-ARKit入门-0/" class="post-title-link" itemprop="url">ARKit入门-建立第一个AR体验</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-11-24 20:01:14" itemprop="dateCreated datePublished" datetime="2017-11-24T20:01:14+08:00">2017-11-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-17 23:13:17" itemprop="dateModified" datetime="2019-06-17T23:13:17+08:00">2019-06-17</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/ARKit/" itemprop="url" rel="index"><span itemprop="name">ARKit</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/ARKit/翻译/" itemprop="url" rel="index"><span itemprop="name">翻译</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>翻译自 <a href="https://developer.apple.com/documentation/arkit/building_your_first_ar_experience" target="_blank" rel="noopener">Building Your First AR Experience</a> </p>
</blockquote>
<p>创建一个运行AR session并利用平面检测使用SceneKit来放置3D内容的app。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>这个示例app运行一个 ARKit 现实追踪 session，并且在 SceneKit 视图中显示内容。为了演示平面检测，这个app仅放置一个 SCNPlane 对象来可视化每个检测到的 ARPlaneAnchor 对象。</p>
<h2 id="配置并运行-AR-Session"><a href="#配置并运行-AR-Session" class="headerlink" title="配置并运行 AR Session"></a>配置并运行 AR Session</h2><p>ARSCNView 类是一个 SceneKit 视图，包括一个 ARSession 对象，该对象用来管理创建AR体验所需的运动跟踪和图像处理。但是，要运行 AR Session，必须要提供一个 Session 配置。</p>
<p><img src="media/15113476634025/15113487703253.jpg" alt></p>
<p> ARWorldTrackingConfiguration 类提供高精度的运动跟踪，并且可以帮助你将虚拟内容放置在真实物体表面。要启动 AR Session，请使用你想要的选项（例如平面检测）来创建一个Session配置对象，然后在ARSCNView实例的session对象上调用run方法：</p>
 <figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> configuration = <span class="type">ARWorldTrackingConfiguration</span>()</span><br><span class="line">configuration.planeDetection = .horizontal</span><br><span class="line">sceneView.session.run(configuration)</span><br></pre></td></tr></table></figure>


<p> 只有在屏幕上显示View的时候才运行session。</p>
<p> <strong>重要：</strong> 如果你的app的核心功能需要使用ARKit，请使用你app的Info.plist文件 UIRequiredDeviceCapabilities 中的 arkit 键，以确保你的app仅在支持ARKit的设备上可用。<br>如果AR只是你app的辅助功能，请使用 isSupported 属性来确定是否提供基于AR的功能。</p>
<h2 id="在检测到的平面上放置3D内容"><a href="#在检测到的平面上放置3D内容" class="headerlink" title="在检测到的平面上放置3D内容"></a>在检测到的平面上放置3D内容</h2><p>在设置好AR session后，可以使用 SceneKit 来放置虚拟内容在视图里。</p>
<p>当启用平面检测时，ARKit 为每个检测到的平面 添加和更新 anchors。默认情况下，ARSCNView 类为每个anchor 添加一个 ACNNode 对象到 SceneKit 场景。你的View的代理可以实现  renderer(_:didAdd:for:) 方法来向场景中添加内容。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">renderer</span><span class="params">(<span class="number">_</span> renderer: SCNSceneRenderer, didAdd node: SCNNode, <span class="keyword">for</span> anchor: ARAnchor)</span></span> &#123;</span><br><span class="line">       <span class="comment">// Place content only for anchors found by plane detection.</span></span><br><span class="line">       <span class="comment">// 将内容仅用于通过平面检测发现的anchor</span></span><br><span class="line">       <span class="keyword">guard</span> <span class="keyword">let</span> planeAnchor = anchor <span class="keyword">as</span>? <span class="type">ARPlaneAnchor</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Create a SceneKit plane to visualize the plane anchor using its position and extent.</span></span><br><span class="line">       <span class="comment">// 创建一个SceneKit平面，以使用其位置和范围来可视化平面anchor</span></span><br><span class="line">       <span class="keyword">let</span> plane = <span class="type">SCNPlane</span>(width: <span class="type">CGFloat</span>(planeAnchor.extent.x), height: <span class="type">CGFloat</span>(planeAnchor.extent.z))</span><br><span class="line">       <span class="keyword">let</span> planeNode = <span class="type">SCNNode</span>(geometry: plane)</span><br><span class="line">       planeNode.simdPosition = float3(planeAnchor.center.x, <span class="number">0</span>, planeAnchor.center.z)</span><br><span class="line">       </span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">        `SCNPlane` is vertically oriented in its local coordinate space, so</span></span><br><span class="line"><span class="comment">        rotate the plane to match the horizontal orientation of `ARPlaneAnchor`.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">       </span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">       `SCNPlane` 在本地坐标空间中是垂直的，所以 旋转这个平面来匹配 ‘ARPlaneAnchor’ 的水平方向。</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">       planeNode.eulerAngles.x = -.pi / <span class="number">2</span></span><br><span class="line">       </span><br><span class="line">       <span class="comment">// Make the plane visualization semitransparent to clearly show real-world placement.</span></span><br><span class="line">       <span class="comment">//  使平面的可视化半透明，以清楚的显示真实事件的位置。</span></span><br><span class="line">       planeNode.opacity = <span class="number">0.25</span></span><br><span class="line">       </span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Add the plane visualization to the ARKit-managed node so that it tracks</span></span><br><span class="line"><span class="comment">        changes in the plane anchor as plane estimation continues.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">       将平面可视化添加到ARKit管理的节点中，以便于跟踪平面anchor的改变，随着平面估计的继续。</span></span><br><span class="line"><span class="comment">       </span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">       node.addChildNode(planeNode)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果将内容添加为与anchor相对应的节点的子节点，ARSCNView类会自动的移动改内容，因为ARKit会优化它对平面位置和范围的估计。为了显示估计平面的全部范围，该示例app还实现了<a href="https://developer.apple.com/documentation/arkit/arscnviewdelegate/2865799-renderer" target="_blank" rel="noopener">renderer(_:didUpdate:for:) </a>方法，更新SCNPlane对象的大小来反映ARKit提供的估计值。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">renderer</span><span class="params">(<span class="number">_</span> renderer: SCNSceneRenderer, didUpdate node: SCNNode, <span class="keyword">for</span> anchor: ARAnchor)</span></span> &#123;</span><br><span class="line">    <span class="comment">// Update content only for plane anchors and nodes matching the setup created in `renderer(_:didAdd:for:)`.</span></span><br><span class="line">    <span class="comment">// 仅更新 平面的anchor ，和在`renderer(_:didAdd:for:)`中创建设置的nodes 匹配的nodes</span></span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> planeAnchor = anchor <span class="keyword">as</span>?  <span class="type">ARPlaneAnchor</span>,</span><br><span class="line">        <span class="keyword">let</span> planeNode = node.childNodes.first,</span><br><span class="line">        <span class="keyword">let</span> plane = planeNode.geometry <span class="keyword">as</span>? <span class="type">SCNPlane</span></span><br><span class="line">        <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Plane estimation may shift the center of a plane relative to its anchor's transform.</span></span><br><span class="line">    <span class="comment">// 平面估计 可能会移动平面的中心，由于其相关联的anchor的中心发生变换。</span></span><br><span class="line">    planeNode.simdPosition = float3(planeAnchor.center.x, <span class="number">0</span>, planeAnchor.center.z)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     Plane estimation may extend the size of the plane, or combine previously detected</span></span><br><span class="line"><span class="comment">     planes into a larger one. In the latter case, `ARSCNView` automatically deletes the</span></span><br><span class="line"><span class="comment">     corresponding node for one plane, then calls this method to update the size of</span></span><br><span class="line"><span class="comment">     the remaining plane.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    平面估计可能会增大平面的尺寸，或者与之前检测到的平面结合成一个更大的平面。</span></span><br><span class="line"><span class="comment">    在后一种情况下，`ARSCNView` 会自动的删除对应平面的节点，然后调用这个方法来更新剩下平面的大小。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    plane.width = <span class="type">CGFloat</span>(planeAnchor.extent.x)</span><br><span class="line">    plane.height = <span class="type">CGFloat</span>(planeAnchor.extent.z)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huangshuai-iot.github.io/2017/06/09/HomeKit Accessory开发基础问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄帅">
      <meta itemprop="description" content="说我能做的，做我说过的">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄帅的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/06/09/HomeKit Accessory开发基础问题/" class="post-title-link" itemprop="url">非商业用途的 HomeKit 配件开发的常见问题</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-06-09 11:02:07" itemprop="dateCreated datePublished" datetime="2017-06-09T11:02:07+08:00">2017-06-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-17 23:13:17" itemprop="dateModified" datetime="2019-06-17T23:13:17+08:00">2019-06-17</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/HomeKit/" itemprop="url" rel="index"><span itemprop="name">HomeKit</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前天在 iOS11 的家庭 app 中看到苹果提醒我自己开发的智能设备没有经过认证，还以为苹果会关闭黑 HomeBridge 协议这个HomeKit接口，没想到 WWDC2017 今天公布了 HomeKit 非商业用途的配件的接入协议。可以让个人开发者接入自己的WiFi和BLE类型的智能硬件设备。本文是对官网 FAQs 的整理。</p>
<h1 id="基础问题"><a href="#基础问题" class="headerlink" title="基础问题"></a>基础问题</h1><p>HomeKit 配件协议（HAP）是苹果专门用来使第三方配件（例如灯、恒湿器和门锁类）和苹果设备（iPhone、iPad、Apple Watch、AppleTV）之间相互通信的协议。HAP 支持两类通信方式：IP 和 BLE 。在 HAP（非商业版）协议中提供了如何为你的非商业用途配件实现 HAP 协议，意思就是我们自己开发的设备怎样以官方认可的方式接入 HomeKit，而不是利用黑 HomeBridge 协议来实现。 </p>
<h2 id="如何获得这个协议规范？"><a href="#如何获得这个协议规范？" class="headerlink" title="如何获得这个协议规范？"></a>如何获得这个协议规范？</h2><p>HomeKit 配件协议规范可以从<a href="https://developer.apple.com/homekit/" target="_blank" rel="noopener">HomeKit开发者网页</a>下载。在你下载文档之前，你需要用你的 AppleID 登陆，然后同意开发协议。</p>
<h2 id="利用本规范开发的配件和利用商业版本的-HomeKit-的配件有什么不同？"><a href="#利用本规范开发的配件和利用商业版本的-HomeKit-的配件有什么不同？" class="headerlink" title="利用本规范开发的配件和利用商业版本的 HomeKit 的配件有什么不同？"></a>利用本规范开发的配件和利用商业版本的 HomeKit 的配件有什么不同？</h2><p>使用本规范创建的配件不包含 Apple 认证协处理器或者获得Wi-Fi Alliance 认证，并且不会在MFI项目下完成 HomeKit 认证。对于用户来说，差异主要是基于IP的附件添加过程，并且在用户继续添加的过程中会弹出警告对话框，说明该设备没有经过苹果认证。</p>
<h2 id="如何开发生产-HomeKit-的配件来发布销售？"><a href="#如何开发生产-HomeKit-的配件来发布销售？" class="headerlink" title="如何开发生产 HomeKit 的配件来发布销售？"></a>如何开发生产 HomeKit 的配件来发布销售？</h2><p>你的公司必须首先参加 MFI 计划，进行商业销售的第三方HomeKit 配件必须在生产销售之前要实现 MFI 计划，包括完成HomeKit 认证。</p>
<h2 id="是否可以在我的配件上添加“Works-with-Apple-HomeKit”标志？"><a href="#是否可以在我的配件上添加“Works-with-Apple-HomeKit”标志？" class="headerlink" title="是否可以在我的配件上添加“Works with Apple HomeKit”标志？"></a>是否可以在我的配件上添加“Works with Apple HomeKit”标志？</h2><p>不允许，这个标志只能用于 MFI 项目并且完成 HomeKit 认证的商业配件。</p>
<h1 id="技术相关问题"><a href="#技术相关问题" class="headerlink" title="技术相关问题"></a>技术相关问题</h1><h2 id="是否可以通过-iOS-内置的家庭app-和-Siri-来控制我的配件，并且创建家庭场景？"><a href="#是否可以通过-iOS-内置的家庭app-和-Siri-来控制我的配件，并且创建家庭场景？" class="headerlink" title="是否可以通过 iOS 内置的家庭app 和 Siri 来控制我的配件，并且创建家庭场景？"></a>是否可以通过 iOS 内置的家庭app 和 Siri 来控制我的配件，并且创建家庭场景？</h2><p>可以，如果你使用 Apple 定义的 HomeKit 服务和本规范中的属性实现HAP协议，并且手机中运行 iOS10 及更高版本，则可以使用家庭app 和 Siri 来控制配件的功能。可以通过<a href="https://support.apple.com/zh-cn/HT204893" target="_blank" rel="noopener">家庭App 使用说明</a>来获得更多帮助。</p>
<h2 id="可以创建一个配件实现-Apple-尚未定义的-HomeKit-服务吗？"><a href="#可以创建一个配件实现-Apple-尚未定义的-HomeKit-服务吗？" class="headerlink" title="可以创建一个配件实现 Apple 尚未定义的 HomeKit 服务吗？"></a>可以创建一个配件实现 Apple 尚未定义的 HomeKit 服务吗？</h2><p>可以，你可以创建一个使用自定义服务类型，并且实现 HAP 协议的配件。但为了控制这个配件，你需要开发一个使用 HomeKit API 的自定义应用程序。但这样你就无法通过家庭应用程序或者Siri 进行控制你的设备了。</p>
<h2 id="我的配件如何与-iOS设备配对？"><a href="#我的配件如何与-iOS设备配对？" class="headerlink" title="我的配件如何与 iOS设备配对？"></a>我的配件如何与 iOS设备配对？</h2><p>对于IP类配件，配件和iOS设备首先得在同一个WiFi网络下，联网显示配件的方式依赖于你所使用的硬件开发平台。然后你可以通过家庭App或者你自己开发的App来完成配对过程。对于BLE类配件，可以像你平常与BLE设备配对那样进行配对。</p>
<h2 id="我是否可以远程控制我的配件，并且使用家庭App设置自动化操作？"><a href="#我是否可以远程控制我的配件，并且使用家庭App设置自动化操作？" class="headerlink" title="我是否可以远程控制我的配件，并且使用家庭App设置自动化操作？"></a>我是否可以远程控制我的配件，并且使用家庭App设置自动化操作？</h2><p>可以，如果配件使用 Apple定义的 HomeKit 服务，并且你将iPad 或者 Apple TV（第四代）设置为家庭中枢，你就可以实现远程控制。有关详细信息，可以查看<a href="https://support.apple.com/zh-cn/HT207057" target="_blank" rel="noopener">自动化和远程访问 HomeKit 配件</a>文档。</p>
<h2 id="HAP使用了什么安全特性？"><a href="#HAP使用了什么安全特性？" class="headerlink" title="HAP使用了什么安全特性？"></a>HAP使用了什么安全特性？</h2><p>HomeKit 配件与 Apple 产品之间通过 HAP 的所有通信都是端到端加密的，并且是相互认证的。</p>
<h2 id="IP类的-HomeKit-配件是否必须实现-Bonjour？"><a href="#IP类的-HomeKit-配件是否必须实现-Bonjour？" class="headerlink" title="IP类的 HomeKit 配件是否必须实现 Bonjour？"></a>IP类的 HomeKit 配件是否必须实现 Bonjour？</h2><p>是的，配件必须实现Bonjour才能被发现。Bonjour代码和规范可以在<a href="https://developer.apple.com/bonjour/" target="_blank" rel="noopener">Bonjour</a>文档中查看。</p>
<h2 id="BLE-类配件是否必须遵守蓝牙核心规范？"><a href="#BLE-类配件是否必须遵守蓝牙核心规范？" class="headerlink" title="BLE 类配件是否必须遵守蓝牙核心规范？"></a>BLE 类配件是否必须遵守蓝牙核心规范？</h2><p>强烈推荐设备遵守蓝牙核心规范，这样可以确保配件的正常运行。</p>
<h2 id="是否可以从-Apple-获得-HomeKitSDK？"><a href="#是否可以从-Apple-获得-HomeKitSDK？" class="headerlink" title="是否可以从 Apple 获得 HomeKitSDK？"></a>是否可以从 Apple 获得 HomeKitSDK？</h2><p>暂时不行。</p>
<h2 id="为什么我的附件在-iOS设备上会有警告对话框？"><a href="#为什么我的附件在-iOS设备上会有警告对话框？" class="headerlink" title="为什么我的附件在 iOS设备上会有警告对话框？"></a>为什么我的附件在 iOS设备上会有警告对话框？</h2><p>不包含Apple认证协处理器的配件将在iOS中触发警告对话框，这表示该配件未经 HomeKit 认证，用户可以点击确认，继续使用该配件。</p>
<h2 id="是否可以在我的配件中添加一个Apple认证协处理器？"><a href="#是否可以在我的配件中添加一个Apple认证协处理器？" class="headerlink" title="是否可以在我的配件中添加一个Apple认证协处理器？"></a>是否可以在我的配件中添加一个Apple认证协处理器？</h2><p>不允许，认证协处理器仅用于商用 HomeKit 配件，该组件只适用于经过MFI认证的公司。</p>
<h2 id="在哪可以提问关于实现HAP的问题？"><a href="#在哪可以提问关于实现HAP的问题？" class="headerlink" title="在哪可以提问关于实现HAP的问题？"></a>在哪可以提问关于实现HAP的问题？</h2><p>向其他开发者或者智能家居爱好者询问技术问题或者讨论 HomeKit 配件协议，请访问<a href="https://forums.developer.apple.com/welcome" target="_blank" rel="noopener">Apple开发者论坛</a>。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huangshuai-iot.github.io/2016/12/29/阿里百川用户反馈Swift开发小结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄帅">
      <meta itemprop="description" content="说我能做的，做我说过的">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄帅的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/12/29/阿里百川用户反馈Swift开发小结/" class="post-title-link" itemprop="url">阿里百川用户反馈Swift开发小结</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-12-29 19:41:25" itemprop="dateCreated datePublished" datetime="2016-12-29T19:41:25+08:00">2016-12-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-16 23:37:13" itemprop="dateModified" datetime="2019-06-16T23:37:13+08:00">2019-06-16</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/开发/" itemprop="url" rel="index"><span itemprop="name">开发</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/开发/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>所有的App都需要给用户一个反馈意见的功能，这样才能让用户使用的更好更方便。不想自己写这一套组件，因此调研了几款第三方的反馈组件。</p>
<h3 id="Instabug"><a href="#Instabug" class="headerlink" title="Instabug"></a>Instabug</h3><p>九月份上架的师大助手App用的就是这个反馈组件，知乎日报用的也是这个，不管在App任何界面摇一摇就可以触发，Instabug会把当前界面进行截图并且支持用户编辑，非常方便好用的组件，这个用来反馈bug我觉得非常好用，但是作为反馈意见的话，感觉还是缺少一个入口。另外，Instabug采集Bug还是非常准确的。</p>
<h3 id="LeanCloud"><a href="#LeanCloud" class="headerlink" title="LeanCloud"></a>LeanCloud</h3><p>LeanCloud的反馈组件号称两行代码接入，非常方便，它做成一个对话框的形式，客服与用户可以进行交流，并且用户的反馈可以及时发给开发人员的LeanCloud 手机客户端，实时性非常高。</p>
<h3 id="阿里百川"><a href="#阿里百川" class="headerlink" title="阿里百川"></a>阿里百川</h3><p>一年之前开发的app用了阿里百川（阿里巴巴无限开放平台）的即时通讯功能，当时阿里巴巴刚把友盟这些公司收购，阿里巴巴无线开放平台还没有现在这么多功能，一年过去了，现在的功能已经非常多了。今天看用户反馈功能时，看到了他们的2.0版本的反馈组件，觉得这种加入了常见反馈问题这一页特别好，用户在反馈之前，可以先自行查看相似问题的解答。并且，相似问题的解答是可以实时在后台添加修改，这极大方便了用户。</p>
<p>于是就暂定了使用阿里百川，于是进行了接入的技术验证。先看一下效果图：</p>
<div id="tt" style="display: inline-block;">
       <img src="http://7xqj7o.com1.z0.glb.clouddn.com/blog/Blog_Baichuan_1.PNG" width="50%" height="25%">
       <img src="http://7xqj7o.com1.z0.glb.clouddn.com/blog/Blog_Baichuan_2.PNG" width="50%" height="25%">
</div>

<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="Part1-阿里百川平台注册"><a href="#Part1-阿里百川平台注册" class="headerlink" title="Part1 阿里百川平台注册"></a>Part1 阿里百川平台注册</h3><p>这里按照官方的接入流程就可以很容易完成了，就不赘述了。</p>
<h3 id="Part2-用户反馈SDK导入"><a href="#Part2-用户反馈SDK导入" class="headerlink" title="Part2 用户反馈SDK导入"></a>Part2 用户反馈SDK导入</h3><p>我选择使用的是专业版2.0，SDK用的是Cocoapods安装方式，在Podfile添加阿里的私有源。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">source 'http:<span class="comment">//repo.baichuan-ios.taobao.com/baichuanSDK/AliBCSpecs.git'</span></span><br><span class="line">source 'http:<span class="comment">//repo.baichuan-ios.taobao.com/baichuanSDK/AliBCSpecsMirror.git'</span></span><br><span class="line">target '<span class="type">YourTargetName'</span> <span class="keyword">do</span></span><br><span class="line">    pod '<span class="type">YWFeedbackFMWK'</span>, '~&gt; <span class="number">2.0</span>.<span class="number">3.1</span>'</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>接着使用 <code>pod install</code> 安装出现了一个问题，就是我之前用的 Alamofire 等其他很多组件安装不了，出现需要更新的问题，我这里猜测 AliBCSpecsMirror 和 CocoaPods/Specs 有一些差异，弄了一会索性直接在上面再添加 CocoaPods 的仓库，<code>source &#39;https://github.com/CocoaPods/Specs.git&#39;</code>, 这样就能同时安装YWFeedbackFMWK和我之前的其他组件了，但是又会出现repo仓库有两份的warning，这个还没解决好，我考完试再找找解决方法。</p>
<p>注意： Cocoapods集成方式不需要手动添加依赖系统库</p>
<p>修改编译选项：<br>在Target-&gt;Linking-&gt;Other Linker Flags中添加-ObjC选项。</p>
<p>iOS 10中隐私权限设置：<br>如果不做设置，可能会导致崩溃、审核不通过等情况。需要在info plist中增加字段：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">key</span>&gt;</span>NSCameraUsageDescription<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">string</span>&gt;</span>访问相机<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">key</span>&gt;</span>NSPhotoLibraryUsageDescription<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">string</span>&gt;</span>访问相册<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Part3-初始化SDK，打开反馈页面"><a href="#Part3-初始化SDK，打开反馈页面" class="headerlink" title="Part3 初始化SDK，打开反馈页面"></a>Part3 初始化SDK，打开反馈页面</h3><ol>
<li>在桥接头文件中加入：</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">import</span> &lt;YWFeedbackFMWK/YWFeedbackKit.h&gt;</span><br><span class="line">#<span class="keyword">import</span> &lt;YWFeedbackFMWK/YWFeedbackViewController.h&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>调用初始化方法：</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bcKit = <span class="type">BCFeedbackKit</span>(appKey: <span class="string">"自己的appkey"</span>)</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>这里需要将在阿里百川后台生成的安全图片添加进项目目录中</p>
<ol start="3">
<li>设置业务方扩展的反馈数据：<br>相当于给反馈信息中加入反馈用户的个人信息，可设置任意字段，在创建反馈页面前设置，可在后台扩展信息中查看。</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bcKit.extInfo = [<span class="string">"username"</span>:<span class="string">"自己app用户体系中的用户id"</span>]</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>打开反馈页面：</li>
<li><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">bcKit.makeFeedbackViewController(completionBlock: &#123; (feedbackVC, error) <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> vc = feedbackVC &#123;</span><br><span class="line">    <span class="comment">// 当用户关闭用户反馈，将调用该block进行dismiss或pop</span></span><br><span class="line">        vc.closeBlock = &#123;(aParentController) <span class="keyword">in</span></span><br><span class="line">            aParentController?.navigationController?.popViewController(animated: <span class="literal">false</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.navigationController?.isNavigationBarHidden = <span class="literal">false</span>        </span><br><span class="line">        <span class="keyword">self</span>.navigationController?.pushViewController(vc, animated: <span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>这样就完成了在app中加入反馈页面的添加。</p>
<h3 id="Part4-阿里百川控制台配置反馈组件"><a href="#Part4-阿里百川控制台配置反馈组件" class="headerlink" title="Part4 阿里百川控制台配置反馈组件"></a>Part4 阿里百川控制台配置反馈组件</h3><p>在阿里百川用户反馈后台，可以在App内反馈中查看用户发送的反馈信息，还可以在Mobile客户端配置中自定义配置app中反馈页面的UI。这是我觉得的该产品的亮点所在，可以实时配置热门问题，减去了在app开发时需要考虑的动态获取生成热门问题的过程，而且整个appUI全都实时动态设置。具体操作大家用一下就很容易了解了。</p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>通过使用阿里百川用户反馈组件，我又一次看到了H5的用途。对于这类弱使用强度、高数据变更、低页面逻辑的页面，我觉得H5的用途大大体现了，虽然讲这样的一个反馈的原生页面以及一套后台处理系统没有什么技术实现上的困难点，但是对于大部分app开发来讲，还是需要消耗时间精力来做的，更重要的是这不是用户使用app的刚需，因此这种即插即用可服务端实时配置的H5反馈页面的出现恰到好处。</p>
<h2 id="番外篇"><a href="#番外篇" class="headerlink" title="番外篇"></a>番外篇</h2><p>push 百川 feedbackVC 的时候，因此 NavigationBar 部分会黑一下再显示。很奇怪的是我如果在 push之前 navigationController 隐藏了 NavigationBar ，这个 feedbackVC 就没有了 NavigationBar。反馈页面其实就是一个 webView，因此我没有搞懂为什么 navigationController 的NavigationBar 显示与否会影响一个 webView 里面 H5 页面的 NavigationBar 显示。这个问题我得再研究研究。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huangshuai-iot.github.io/2016/10/11/iOS10-Today-Extension-开发小结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄帅">
      <meta itemprop="description" content="说我能做的，做我说过的">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄帅的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/10/11/iOS10-Today-Extension-开发小结/" class="post-title-link" itemprop="url">iOS10 Today Extension 开发小结 </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-10-11 17:30:20" itemprop="dateCreated datePublished" datetime="2016-10-11T17:30:20+08:00">2016-10-11</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-16 23:37:13" itemprop="dateModified" datetime="2019-06-16T23:37:13+08:00">2019-06-16</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/开发/" itemprop="url" rel="index"><span itemprop="name">开发</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/开发/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>9.15号中秋节那天发布了<a href="https://itunes.apple.com/us/app/shi-da-zhu-shou-hui-shi-fan/id1150983683?l=zh&ls=1&mt=8" target="_blank" rel="noopener">师大助手App</a>后，就在想还加点什么功能。后来想到了可以在 Today Widgets 里面加一个今日课程，于是就开始动手做了。先给大家看一下最终效果：<br><img src="http://7xqj7o.com1.z0.glb.clouddn.com/blog/Blog_Widgets_1" alt="最终效果"><br>一开始开发的时候，还是 Xcode7 和 Swift2 ，等到准备上架审核的时候，Xcode8 正式版发布了，然后就做了 Swift3 迁移和 iOS10 适配。</p>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="Part1-基本搭建"><a href="#Part1-基本搭建" class="headerlink" title="Part1 基本搭建"></a>Part1 基本搭建</h3><ol>
<li>新建 iOS Project ，这就不用说了哈</li>
<li>新建一个 Target ，选择 Today-Extension ，Target名字就设置为 TodayWidget</li>
<li>在 MainInterface.storyboard 画 UI ，然后运行就可以看到效果了，由于我是显示课程，就在里面添加了一个 UITableView ，并且增加了两个 Prototype Cell 用于自定义Cell</li>
</ol>
<h3 id="Part2-依赖项目引入"><a href="#Part2-依赖项目引入" class="headerlink" title="Part2 依赖项目引入"></a>Part2 依赖项目引入</h3><ol>
<li><p>在 Podfile 项目中新建一个target，并加入需要引入的项目，代码如下：</p>
 <figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">target '<span class="type">TodayWidget'</span> <span class="keyword">do</span></span><br><span class="line">  pod '<span class="type">YYModel'</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 TodayWidget Target 下面新建一个桥接头文件，这里为省去设置的头文件的方法，可以直接新建oc文件，xcode会问你要不要自动添加一个桥接头文件，建好之后删除oc文件即可</p>
</li>
<li><p>接下来在测试过程中，我们就可以愉快的通过 Cocoapods 使用第三方库了，但是提交代码到AppStore就会报如下的错误了：<br> <img src="http://7xqj7o.com1.z0.glb.clouddn.com/blog/Blog_Widgets_2" alt="上传报错"></p>
</li>
<li><p>解决targets不能使用Cocoapods的方法是：在TodayWidget -&gt; Build Phases -&gt; New Run Script Phase ，再添加如下代码</p>
 <figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="string">"$&#123;CONFIGURATION_BUILD_DIR&#125;/$&#123;UNLOCALIZED_RESOURCES_FOLDER_PATH&#125;/"</span></span><br><span class="line"><span class="keyword">if</span> [[ -d <span class="string">"Frameworks"</span> ]]; then</span><br><span class="line">rm -fr <span class="type">Frameworks</span></span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
</li>
<li><p>这样就可以顺利提交到AppStore了</p>
</li>
</ol>
<h3 id="Part3-TodayExtension-Target-和-main-Target-之间数据共享"><a href="#Part3-TodayExtension-Target-和-main-Target-之间数据共享" class="headerlink" title="Part3 TodayExtension Target 和 main Target 之间数据共享"></a>Part3 TodayExtension Target 和 main Target 之间数据共享</h3><p>在讲如何具体实现数据共享之前，需要先打开两个Target -&gt; Capabilities -&gt; App Groups，只有在同一个Groups内的target才能共同读写数据。<br><img src="http://7xqj7o.com1.z0.glb.clouddn.com/blog/Blog_Widgets_3.png" alt="设置Group"><br>有两种解决方式：UserDefaults 和 FileManager </p>
<h4 id="Solution1-UserDefaults方式"><a href="#Solution1-UserDefaults方式" class="headerlink" title="Solution1  UserDefaults方式"></a>Solution1  UserDefaults方式</h4><p>UserDefaults Apple 官方文档：</p>
<blockquote>
<p>The NSUserDefaults class provides a programmatic interface for interacting with the defaults system. The defaults system allows an application to customize its behavior to match a user’s preferences. For example, you can allow users to determine what units of measurement your application displays or how often documents are automatically saved. Applications record such preferences by assigning values to a set of parameters in a user’s defaults database. The parameters are referred to as defaults since they’re commonly used to determine an application’s default state at startup or the way it acts by default.</p>
</blockquote>
<p>在本App中，我需要将当前是第几教学周在 targets 间传递，数据量很小，于是采用了 UserDefaults 方法，代码如下：<br>    <figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 写入</span></span><br><span class="line"><span class="type">UserDefaults</span>.<span class="keyword">init</span>(suiteName: <span class="string">"group.com.huangshuai.xxx"</span>)?.<span class="keyword">set</span>(week, forKey: <span class="string">"currentWeek"</span>)</span><br><span class="line"><span class="comment">// 读取</span></span><br><span class="line"><span class="keyword">let</span> currentWeek = <span class="type">UserDefaults</span>.<span class="keyword">init</span>(suiteName: <span class="string">"group.com.huangshuai.xxx"</span>)?.object(forKey: <span class="string">"currentWeek"</span>) <span class="keyword">as</span>? <span class="type">Int</span> ?? <span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p>注：这里是 group 间的 UserDefaults 数据共享，而不是平常的单一target下面的 UserDefaults 使用：<br>    <figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 写入</span></span><br><span class="line"><span class="type">UserDefaults</span>.standard.<span class="keyword">set</span>(<span class="literal">false</span>, forKey: <span class="string">"isFirstLaunch"</span>)</span><br><span class="line"><span class="comment">// 读取</span></span><br><span class="line"><span class="keyword">let</span> isFirstLaunch = <span class="type">UserDefaults</span>.standard.object(forKey: <span class="string">"isFirstLaunch"</span>) <span class="keyword">as</span>? <span class="type">Bool</span> ?? <span class="literal">true</span></span><br></pre></td></tr></table></figure></p>
<h4 id="Solution2-FileManager方式"><a href="#Solution2-FileManager方式" class="headerlink" title="Solution2  FileManager方式"></a>Solution2  FileManager方式</h4><p>FileManager Apple 官方文档：</p>
<blockquote>
<p>An FileManager object lets you examine the contents of the file system and make changes to it. The FileManager class provides convenient access to a shared file manager object that is suitable for most types of file-related manipulations. A file manager object is typically your primary mode of interaction with the file system. You use it to locate, create, copy, and move files and directories. You also use it to get information about a file or directory or change some of its attributes.</p>
</blockquote>
<p>在本App中，我需要将所有的课表数据在 targets 间传递，数据量较大，于是采用了 FileManager 方法，代码如下：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> name = <span class="string">"course.plist"</span></span><br><span class="line"><span class="keyword">let</span> groupPath = <span class="type">FileManager</span>.<span class="keyword">default</span>.containerURL(forSecurityApplicationGroupIdentifier: <span class="string">"group.com.huangshuai.xxx"</span>)</span><br><span class="line"><span class="keyword">let</span> groupPathString = groupPath!.absoluteString.replacingOccurrences(of:<span class="string">"file:///private"</span>, with: <span class="string">""</span>).replacingOccurrences(of:<span class="string">"file:///"</span>, with: <span class="string">""</span>)</span><br><span class="line">destPath = (groupPathString <span class="keyword">as</span> <span class="type">NSString</span>).appendingPathComponent(name).characters.<span class="built_in">split</span>&#123;$<span class="number">0</span> == <span class="string">"."</span>&#125;.<span class="built_in">map</span>(<span class="type">String</span>.<span class="keyword">init</span>).first!</span><br><span class="line"><span class="comment">// 写入</span></span><br><span class="line"><span class="keyword">let</span> dic = [:] <span class="keyword">as</span> <span class="type">NSDictionary</span></span><br><span class="line">dic.write(toFile: destPath, atomically: <span class="literal">true</span>)</span><br><span class="line"><span class="comment">// 读取</span></span><br><span class="line"><span class="keyword">let</span> dict = <span class="type">NSDictionary</span>(contentsOfFile: destPath)</span><br></pre></td></tr></table></figure>


<h3 id="Part4-适配-iOS10-Widgets-新特性"><a href="#Part4-适配-iOS10-Widgets-新特性" class="headerlink" title="Part4 适配 iOS10 Widgets 新特性"></a>Part4 适配 iOS10 Widgets 新特性</h3><h4 id="处理-Widgets-展开-折叠的情况"><a href="#处理-Widgets-展开-折叠的情况" class="headerlink" title="处理 Widgets 展开/折叠的情况"></a>处理 Widgets 展开/折叠的情况</h4><p>在 iOS10 之前，Widgets 的高度可以自定义设置，但是在 iOS10 中，Widgets 的 activeDisplayMode 有两种状态：.expanded 和 .compact。 需要根据当前用户的选择来处理 Widgets 的高度，代码如下：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@available</span>(iOSApplicationExtension <span class="number">10.0</span>, *)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">widgetActiveDisplayModeDidChange</span><span class="params">(<span class="number">_</span> activeDisplayMode: NCWidgetDisplayMode, withMaximumSize maxSize: CGSize)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> activeDisplayMode == .compact &#123;</span><br><span class="line">        <span class="keyword">self</span>.preferredContentSize = maxSize</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.preferredContentSize = <span class="keyword">self</span>.tableView.contentSize</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有个Bug：就是在 .compact 下无法设置尺寸，不管怎么设置都是 maxsize。还有待解决。</p>
<h4 id="处理-Widgets-在-iOS9-和-iOS10-下的显示-Bug"><a href="#处理-Widgets-在-iOS9-和-iOS10-下的显示-Bug" class="headerlink" title="处理 Widgets 在 iOS9 和 iOS10 下的显示 Bug"></a>处理 Widgets 在 iOS9 和 iOS10 下的显示 Bug</h4><p>在 iOS10 中，Widgets 的背景是白色的，于是字体颜色设置为黑色的，但是在 iOS9 中，背景是黑色的，App 在iOS9中运行就会看不见字。感觉这是iOS10适配的Bug，为了解决这个问题，只能通过判断系统版本来设置字体颜色了，代码如下：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> #available(iOSApplicationExtension <span class="number">10.0</span>, *) &#123;</span><br><span class="line">    mainTextColor = <span class="type">UIColor</span>.black</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mainTextColor = <span class="type">UIColor</span>.white</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Bug"><a href="#Bug" class="headerlink" title="Bug:"></a>Bug:</h4><p>在 iOS10 下，Widgets 的 displayBundleName 设置也不起作用了，不管怎么设置只跟 mainTarget 的displayBundleName 一致，还未找到解决方法。</p>
<h2 id="番外篇"><a href="#番外篇" class="headerlink" title="番外篇"></a>番外篇</h2><p>女票说她们学校课程很多，每天看课表不方便，在国庆节陪她过生日的时候，现场撸了一个App只供她使用，她每次不用解锁直接下拉Widgets就可以看到今日课程，她开心的不得了还发了朋友圈炫耀一番。哈哈，女票是第一生产力☺️</p>
<p>说到这，本文也就结束了，以上提到的Bug，我会在解决之后再来更新代码。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huangshuai-iot.github.io/2016/10/08/Swift3-迁移小结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄帅">
      <meta itemprop="description" content="说我能做的，做我说过的">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄帅的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/10/08/Swift3-迁移小结/" class="post-title-link" itemprop="url">Swift3 迁移小结</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-10-08 22:56:05" itemprop="dateCreated datePublished" datetime="2016-10-08T22:56:05+08:00">2016-10-08</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-16 23:37:13" itemprop="dateModified" datetime="2019-06-16T23:37:13+08:00">2019-06-16</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/开发/" itemprop="url" rel="index"><span itemprop="name">开发</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/开发/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>9.15号中秋节那天发布了<a href="https://itunes.apple.com/us/app/shi-da-zhu-shou-hui-shi-fan/id1150983683?l=zh&ls=1&mt=8" target="_blank" rel="noopener">师大助手App</a>，后来有次在 Yosemite OS 下更新到 Xcode8 ，打开后项目一片红，当时只是想修复一下 bug，还没想要迁移到 Swift3，于是默默的 重新装了 Xcode7，又继续愉快的改bug了，然后9月20号提交到商店更新也没问题。21号提示 Sierra 可以更新了，于是手贱更新了一波。然后悲剧就开始了。<br>更新完 Sierra 后，我添加了Widgets功能，于是准备上传到商店，然后就是 一直传不上去。试了一下几个方法：</p>
<ol>
<li>Xcode7 打包，Xcode8 上传</li>
<li>Xcode7 打包，在 Sierra 下用 Application Loader 上传</li>
<li>Xcode7 打包，在同学 Yosemite 下用 Application Loader 上传</li>
</ol>
<p>结果以上都不行，一直卡在验证那里，于是我就一狠心，说用 Xcode8 ，做一下 Swift3 迁移😂，开启了升级打怪之旅</p>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="自动代码-Convert"><a href="#自动代码-Convert" class="headerlink" title="自动代码 Convert"></a>自动代码 Convert</h3><p>在这里，我只 Convert 自己写的代码，事实证明是明智的，因为第三方库自己都做了适配，不需要我们来进行 Convert，这一步做完，自己的代码大致上没什么问题了，主要错误都集中在第三方库的接口调用上</p>
<h3 id="第三方库-Update"><a href="#第三方库-Update" class="headerlink" title="第三方库 Update"></a>第三方库 Update</h3><p>我有个习惯，就是 update 之前喜欢先去项目主页看一下，看看有没有什么坑。</p>
<h4 id="CocoaPods"><a href="#CocoaPods" class="headerlink" title="CocoaPods"></a>CocoaPods</h4><ol>
<li><p>卸载已有的 CocoaPods (非必须)</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ which pod</span><br><span class="line">/usr/local/bin/pod</span><br><span class="line">$ sudo rm -rf /usr/local/bin/pod</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装支持 Xcode8 的 CocoaPods</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gem install cocoapods --pre</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>更新完 CocoaPods 还有更新本地库，就不说了。</p>
<h4 id="Alamofire"><a href="#Alamofire" class="headerlink" title="Alamofire"></a>Alamofire</h4><p>去官网看了一下，真是坑爹，Alamofire 4.0 变化好大，接口都按照 Swift3 重新弄了，二话不说，先更新一下。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod '<span class="type">Alamofire'</span>, '~&gt; <span class="number">4.0</span>'</span><br></pre></td></tr></table></figure>

<p>基本的代码更新看<a href="https://github.com/Alamofire/Alamofire/blob/master/Documentation/Alamofire%204.0%20Migration%20Guide.md" target="_blank" rel="noopener">官方文档</a>就差不多了。下面写几个官方文档没有提到的：</p>
<h5 id="配置https证书"><a href="#配置https证书" class="headerlink" title="配置https证书"></a>配置https证书</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">configureAlamofireManager</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="keyword">let</span> manager = <span class="type">SessionManager</span>.<span class="keyword">default</span></span><br><span class="line">   manager.delegate.sessionDidReceiveChallenge = &#123; session, challenge <span class="keyword">in</span></span><br><span class="line">       <span class="keyword">var</span> disposition: <span class="type">URLSession</span>.<span class="type">AuthChallengeDisposition</span> = .performDefaultHandling</span><br><span class="line">       <span class="keyword">var</span> credential: <span class="type">URLCredential?</span></span><br><span class="line">       </span><br><span class="line">       <span class="keyword">if</span> challenge.protectionSpace.authenticationMethod == <span class="type">NSURLAuthenticationMethodServerTrust</span> &#123;</span><br><span class="line">           disposition = <span class="type">URLSession</span>.<span class="type">AuthChallengeDisposition</span>.useCredential</span><br><span class="line">           credential = <span class="type">URLCredential</span>(trust: challenge.protectionSpace.serverTrust!)</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> challenge.previousFailureCount &gt; <span class="number">0</span> &#123;</span><br><span class="line">               disposition = .cancelAuthenticationChallenge</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               credential = manager.session.configuration.urlCredentialStorage?.defaultCredential(<span class="keyword">for</span>: challenge.protectionSpace)</span><br><span class="line">               </span><br><span class="line">               <span class="keyword">if</span> credential != <span class="literal">nil</span> &#123;</span><br><span class="line">                   disposition = .useCredential</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> (disposition, credential)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="自定义Request请求"><a href="#自定义Request请求" class="headerlink" title="自定义Request请求"></a>自定义Request请求</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> urlRequest = urlRequestWithComponents(<span class="type">SchoolNetWorkBaseURL</span>, parameters: parameters)</span><br><span class="line"><span class="type">Alamofire</span>.upload(urlRequest.<span class="number">1</span>, with: urlRequest.<span class="number">0</span>).response &#123;</span><br><span class="line">    response <span class="keyword">in</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">let</span> htmlString:<span class="type">String</span> = <span class="type">NSString</span>(data: response.data!, encoding: <span class="type">GB2312Encoding</span>)! <span class="keyword">as</span> <span class="type">String</span></span><br><span class="line">    <span class="built_in">print</span>(htmlString)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">urlRequestWithComponents</span><span class="params">(<span class="number">_</span> urlString:String,parameters:[String: AnyObject])</span></span> -&gt; (<span class="type">URLRequestConvertible</span>,<span class="type">Data</span>) &#123;</span><br><span class="line">        </span><br><span class="line">   <span class="comment">// create  url request to send</span></span><br><span class="line">   <span class="keyword">var</span> mutableURLRequest = <span class="type">URLRequest</span>(url: <span class="type">URL</span>(string: urlString)!)</span><br><span class="line">   mutableURLRequest.httpMethod = <span class="type">HTTPMethod</span>.post.rawValue</span><br><span class="line">   <span class="keyword">let</span> contentType = <span class="string">"application/x-www-form-urlencoded"</span></span><br><span class="line">   mutableURLRequest.setValue(contentType, forHTTPHeaderField: <span class="string">"Content-Type"</span>)</span><br><span class="line">   mutableURLRequest.setValue(<span class="string">"****"</span>, forHTTPHeaderField: <span class="string">"Referer"</span>)</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// add parameters</span></span><br><span class="line">   <span class="keyword">var</span> uploadData = <span class="type">Data</span>()</span><br><span class="line">   <span class="keyword">for</span> (key,value) <span class="keyword">in</span> parameters &#123;</span><br><span class="line">       uploadData.append(<span class="string">"\(key)=\(value)&amp;"</span>.data(using: <span class="type">String</span>.<span class="type">Encoding</span>(rawValue: <span class="type">GB2312Encoding</span>))!)</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">return</span> (<span class="keyword">try</span>! <span class="type">URLEncoding</span>.<span class="keyword">default</span>.encode(mutableURLRequest, with: <span class="literal">nil</span>),uploadData)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Eureka"><a href="#Eureka" class="headerlink" title="Eureka"></a>Eureka</h4><p>Eureka 在新版本中删除了 ImageRow，我之前代码有一处无法调用，后来提了个<a href="https://github.com/xmartlabs/Eureka/issues/688" target="_blank" rel="noopener">issue</a>，问了作者。<br><img src="http://7xqj7o.com1.z0.glb.clouddn.com/blog/Blog_Swift3_1.png" alt="Issue"><br>由于在 iOS10 中，app 需要对相册和相机的使用进行权限申明，不然会闪退，未避免其他 app 闪退，就删了 imageRow，作者也给了解决方法，按照他给方法，本地添加 imageRow 就可继续使用了，或者自己实现CustomRow，准备过段时间试一下自定义 CustomRow。</p>
<h4 id="Kanna"><a href="#Kanna" class="headerlink" title="Kanna"></a>Kanna</h4><p>项目中需要解析 html ，一直用的 Kanna，在 swift3 中，原来的<code>doc.xpath(&quot;//table/tr&quot;).count</code>变成了 <code>doc.xpath(&quot;//table/tr&quot;).nodeSet.count</code>。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huangshuai-iot.github.io/2016/08/09/Swift使用Xib自定义View和Cell/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄帅">
      <meta itemprop="description" content="说我能做的，做我说过的">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄帅的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/08/09/Swift使用Xib自定义View和Cell/" class="post-title-link" itemprop="url">Swift 使用 Xib 自定义 View 和 Cell</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-08-09 17:06:52" itemprop="dateCreated datePublished" datetime="2016-08-09T17:06:52+08:00">2016-08-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-16 23:37:13" itemprop="dateModified" datetime="2019-06-16T23:37:13+08:00">2019-06-16</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/开发/" itemprop="url" rel="index"><span itemprop="name">开发</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/开发/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>原来一直使用的是Storyboard自定义<code>UITableViewCell</code>的，暑期来公司实习，发现公司用的是Xib自定义View，学长说人多用SB不好协同工作。除了这个原因，我之前还发现Storyboard的复用性不好，自定义的Cell不能在多个Storyboard文件中复用😂。</p>
<p>下面介绍利用Xib自定义View和Cell。</p>
<h1 id="自定义Cell"><a href="#自定义Cell" class="headerlink" title="自定义Cell"></a>自定义Cell</h1><p>新建Cell文件时，勾选生成Xib文件。然后在Xib上使用控件和约束，和Storyboard一样。</p>
<p>在使用自定义的Cell时，要记得注册可复用的Cell。例如:<code>collectionView.registerReusableCell(FMPersonHelpReportVCCollectionViewCell)</code></p>
<p>剩下的使用过程和用Storyboard自定义的Prototype Cell是一致的。</p>
<h1 id="自定义View"><a href="#自定义View" class="headerlink" title="自定义View"></a>自定义View</h1><p>新建View的时候，是无法勾选生成Xib文件的，所以需要我们自己创建同名的UIView和Xib文件。并且将 Xib文件的 File’s Owner -&gt; Custom Class -&gt; Class 属性设为刚才新建的类。</p>
<p>由于自定义View不能直接从View初始化，所以写了一个基类。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseXibView</span>: <span class="title">UIView</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> view:<span class="type">UIView?</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//初始化方法。</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">initFromXib</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//获取Xib文件名字</span></span><br><span class="line">        <span class="keyword">let</span> xibName = <span class="type">NSStringFromClass</span>(<span class="keyword">self</span>.classForCoder)</span><br><span class="line">        <span class="keyword">let</span> xibClassName = xibName.characters.<span class="built_in">split</span>&#123;$<span class="number">0</span> == <span class="string">"."</span>&#125;.<span class="built_in">map</span>(<span class="type">String</span>.<span class="keyword">init</span>).last</span><br><span class="line">        <span class="comment">//使用Xib初始化一个View</span></span><br><span class="line">        <span class="keyword">let</span> view = <span class="type">NSBundle</span>.mainBundle().loadNibNamed(xibClassName, owner: <span class="keyword">self</span>, options: <span class="literal">nil</span>).first <span class="keyword">as</span>! <span class="type">UIView</span></span><br><span class="line">        view.frame = <span class="keyword">self</span>.bounds</span><br><span class="line">        view.translatesAutoresizingMaskIntoConstraints = <span class="literal">true</span></span><br><span class="line">        view.autoresizingMask = [.<span class="type">FlexibleWidth</span>,.<span class="type">FlexibleHeight</span>]</span><br><span class="line">        <span class="keyword">self</span>.addSubview(view)</span><br><span class="line">        <span class="keyword">self</span>.view = view</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">init</span>(frame: <span class="type">CGRect</span>) &#123;</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame)</span><br><span class="line">        initFromXib()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>(coder aDecoder: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(coder:aDecoder)!</span><br><span class="line">        initFromXib()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是我写的一个自定义View，主要用来进行新手引导的，覆盖在原视图上，点击view，慢慢改变透明度。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FMHomeNewUserGuideView</span>: <span class="title">BaseXibView</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">var</span> imageView: <span class="type">UIImageView!</span></span><br><span class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">var</span> label: <span class="type">UILabel!</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> isMainView = <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">initFromXib</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.initFromXib()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">touchesBegan</span><span class="params">(touches: Set&lt;UITouch&gt;, withEvent event: UIEvent?)</span></span> &#123;</span><br><span class="line">        <span class="type">UIView</span>.animateWithDuration(<span class="number">0.25</span>, animations: &#123; </span><br><span class="line">            <span class="keyword">self</span>.alpha = <span class="number">0</span></span><br><span class="line">            &#125;) &#123; (isComplete) <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">self</span>.removeSubviews()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">setUI</span><span class="params">()</span></span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用法：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> homeNewUserGuideView = <span class="type">FMHomeNewUserGuideView</span>()</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1>
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huangshuai-iot.github.io/2016/08/02/Swift模拟登陆小结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄帅">
      <meta itemprop="description" content="说我能做的，做我说过的">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄帅的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/08/02/Swift模拟登陆小结/" class="post-title-link" itemprop="url">Swift 模拟登陆小结</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-08-02 18:27:36" itemprop="dateCreated datePublished" datetime="2016-08-02T18:27:36+08:00">2016-08-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-16 23:37:13" itemprop="dateModified" datetime="2019-06-16T23:37:13+08:00">2019-06-16</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/开发/" itemprop="url" rel="index"><span itemprop="name">开发</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/开发/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>过完年在学校度过大学的最后一学期，期间加深学习了Python的Django和iOS开发。在学习的过程中，就想着临走前做一个校园应用。由于我们的需要的信息分散在学校各个部门的系统中，此时就需要通过模拟登陆来获取我们想要的信息。一开始是用python来模拟登陆解析数据的，后期由于我对架构设计的改变（主要是服务器资源和流量没钱买😂），我把很多解析放在手机端（暂时为iOS端）来处理，所以就应运而出本篇博文。</p>
<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><p>要模拟浏览器登陆，首先得分析浏览器登陆的步骤，再用代码来实现。在分析浏览器登陆之前先介绍一下使用到的工具。</p>
<h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><h3 id="Charles"><a href="#Charles" class="headerlink" title="Charles"></a>Charles</h3><p>这是一款常用的网络封包截取工具，在做开发时，我们为了调试与服务器端的网络通讯协议，常常需要截取网络封包来分析。Mac和PC都可以使用。今天好像发布了新版了。这个还可以作为iPhone的http代理，来抓包手机的网络包。关于此软件的使用详情，可以阅读<a 11 14 2015 href http: blog.devtang.com charles-introduction "">唐巧老师的博客</a>。</p>
<h3 id="Postman"><a href="#Postman" class="headerlink" title="Postman"></a>Postman</h3><p>这是Mac上Chrome的一个网络调试的工具插件，PC上不知道有没有，可以通过该工具来进行各种http请求。</p>
<h3 id="编码工具"><a href="#编码工具" class="headerlink" title="编码工具"></a>编码工具</h3><p>这是一个在线的<a href="http://tool.chinaz.com/tools/urlencode.aspx" target="_blank" rel="noopener">站长工具</a>，可以进行各类编码间的转换，最常用的应该就是utf-8的UrlDecode和UrlEncode。这个工具还非常贴心的提供了gb2312格式的UrlDecode和UrlEncode。</p>
<h3 id="Alamofire（iOS网络库）"><a href="#Alamofire（iOS网络库）" class="headerlink" title="Alamofire（iOS网络库）"></a>Alamofire（iOS网络库）</h3><ol>
<li>Alamofire 的前身是 AFNetworking。AFNetworking 是 iOS 和 OS X 上很受欢迎的第三方HTTP网络基础库。</li>
<li>其实 AFNetwork 的前缀 AF 便是 Alamofire 的缩写。</li>
<li>Swift发布后，AFNetworking的作者又用Swift语言写了个相同功能的库，这便是 Alamofire。</li>
<li>Alamofire 本质是基于<code>NSURLSession</code>，并做了封装。使用 Alamofire 可以让我们网络请求相关代码（如获取数据，提交数据，上传文件，下载文件等）更加简洁易用。</li>
</ol>
<p><strong>关于Cookie:</strong><br>Alamofire是基于NSURLRequest封装的，所以Cookie会自动保存，就和浏览器请求是一个效果。而且网站Set_cookie多久，本地的Cookie就多久，每次请求的时候都会自动带上cookie，直到过期。（所以像登陆session这些的都不用我们手动去处理）。</p>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><p>POST请求和GET请求应该就不用解释了，这里提醒一下编码格式，现在大部分服务器都是utf-8编码格式的，但不排除少量用的GB2312。所以在发现服务器响应数据乱码时要检查返回数据的编码格式。</p>
<h2 id="几个例子"><a href="#几个例子" class="headerlink" title="几个例子"></a>几个例子</h2><h3 id="登陆1"><a href="#登陆1" class="headerlink" title="登陆1"></a>登陆1</h3><p>做校园APP想到的第一个功能就是查成绩查课表，于是第一个就是拿教务系统动刀。</p>
<p>通过Charles发现，使用网页登陆教务系统的时候，其实是跳转到一个check页验证账号密码，再跳转回教务系统首页。该网页返回的就是JSON数据，所以用的<code>responseJSON</code>。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Alamofire</span>.request(<span class="type">Method</span>.<span class="type">POST</span>, <span class="type">SchoolBaseURL</span>+<span class="string">"login/check.shtml"</span></span><br><span class="line">, parameters:[<span class="string">"user"</span>:<span class="string">"*****"</span>,<span class="string">"pass"</span>:<span class="string">"*****"</span>,<span class="string">"usertype"</span>:<span class="string">"stu"</span>]</span><br><span class="line">, encoding: <span class="type">ParameterEncoding</span>.<span class="type">URL</span></span><br><span class="line">, headers: <span class="literal">nil</span>).responseJSON &#123;</span><br><span class="line">                response <span class="keyword">in</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">guard</span> response.result.isSuccess  <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">self</span>.callback?.managerApiCallBackFailed(<span class="keyword">self</span>)</span><br><span class="line">                <span class="type">Hud</span>.showError(<span class="string">"网络错误了"</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 登陆成功</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="登陆2"><a href="#登陆2" class="headerlink" title="登陆2"></a>登陆2</h3><p>想到的第二个功能就是查询校园网流量使用情况，于是瞄上了信息管理中心的校园网系统。</p>
<p>这里请求时必须带上Content-Type和Referer。否则就会跳到登录页。这个系统就是我讲的GB2312编码的坑货系统。返回的data需要经过GB2312编码。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Alamofire</span>.request(<span class="type">Method</span>.<span class="type">POST</span>, <span class="type">SchoolNetWorkBaseURL</span></span><br><span class="line">, parameters:[<span class="string">"username"</span>:<span class="string">"*****"</span>,<span class="string">"password"</span>:<span class="string">"*****"</span>]</span><br><span class="line">, encoding: <span class="type">ParameterEncoding</span>.<span class="type">URL</span></span><br><span class="line">, headers: [<span class="string">"Content-Type"</span>:<span class="string">"application/x-www-form-urlencoded"</span>,<span class="string">"Referer"</span>:<span class="type">SchoolNetWorkBaseURL</span>]).response &#123;</span><br><span class="line">                request, response, data, error <span class="keyword">in</span> </span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 业务处理</span></span><br><span class="line">                <span class="keyword">let</span> <span class="type">GB2312Encoding</span> = <span class="type">CFStringConvertEncodingToNSStringEncoding</span>(<span class="number">0x0632</span>)</span><br><span class="line">                <span class="keyword">let</span> selfHTMLString:<span class="type">String</span> = <span class="type">NSString</span>(data: data!, encoding: <span class="type">GB2312Encoding</span>)! <span class="keyword">as</span> <span class="type">String</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>弄到这里感觉还比较轻松，但是最坑爹的是，这个网站的请求参数必须是经过GB2312的URLEncode。而Alamofire只能将参数进行utf-8编码。我开始时以为将请求参数用GB2312编码后传入即可，或者利用GB2312编码的URLEncode后再传入。但是都相当于Alamofire在最外层还是用UTF-8又URLEncode了一遍。</p>
<p>这是Alamofire的源码，这里可以由<code>charst=utf-8</code>看出它默认将数据进行utf-8编码。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> method = <span class="type">Method</span>(rawValue: mutableURLRequest.<span class="type">HTTPMethod</span>) <span class="keyword">where</span> encodesParametersInURL(method) &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span></span><br><span class="line">        <span class="type">URLComponents</span> = <span class="type">NSURLComponents</span>(<span class="type">URL</span>: mutableURLRequest.<span class="type">URL!</span>, resolvingAgainstBaseURL: <span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">where</span> !parameters.isEmpty</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> percentEncodedQuery = (<span class="type">URLComponents</span>.percentEncodedQuery.<span class="built_in">map</span> &#123; $<span class="number">0</span> + <span class="string">"&amp;"</span> &#125; ?? <span class="string">""</span>) + query(parameters)</span><br><span class="line">        <span class="type">URLComponents</span>.percentEncodedQuery = percentEncodedQuery</span><br><span class="line">        mutableURLRequest.<span class="type">URL</span> = <span class="type">URLComponents</span>.<span class="type">URL</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> mutableURLRequest.valueForHTTPHeaderField(<span class="string">"Content-Type"</span>) == <span class="literal">nil</span> &#123;</span><br><span class="line">        mutableURLRequest.setValue(</span><br><span class="line">            <span class="string">"application/x-www-form-urlencoded; charset=utf-8"</span>,</span><br><span class="line">            forHTTPHeaderField: <span class="string">"Content-Type"</span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutableURLRequest.<span class="type">HTTPBody</span> = query(parameters).dataUsingEncoding(</span><br><span class="line">        <span class="type">NSUTF8StringEncoding</span>,</span><br><span class="line">        allowLossyConversion: <span class="literal">false</span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里参考学长给的建议，将request先自己编码后再进行传输。首先封装了自定义编码request方法。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">urlRequestWithComponents</span><span class="params">(urlString:String,parameters:[String: AnyObject])</span></span> -&gt; (<span class="type">URLRequestConvertible</span>,<span class="type">NSData</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create  url request to send</span></span><br><span class="line">    <span class="keyword">let</span> mutableURLRequest = <span class="type">NSMutableURLRequest</span>(<span class="type">URL</span>: <span class="type">NSURL</span>(string: urlString)!)</span><br><span class="line">    mutableURLRequest.<span class="type">HTTPMethod</span> = <span class="type">Alamofire</span>.<span class="type">Method</span>.<span class="type">POST</span>.rawValue</span><br><span class="line">    <span class="keyword">let</span> contentType = <span class="string">"application/x-www-form-urlencoded"</span></span><br><span class="line">    mutableURLRequest.setValue(contentType, forHTTPHeaderField: <span class="string">"Content-Type"</span>)</span><br><span class="line">    mutableURLRequest.setValue(<span class="string">"http://nic.ahnu.edu.cn/cgi-bin/service"</span>, forHTTPHeaderField: <span class="string">"Referer"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// add parameters</span></span><br><span class="line">    <span class="keyword">let</span> uploadData = <span class="type">NSMutableData</span>()</span><br><span class="line">    <span class="keyword">for</span> (key,value) <span class="keyword">in</span> parameters &#123;</span><br><span class="line">        uploadData.appendData(<span class="string">"\(key)=\(value)&amp;"</span>.dataUsingEncoding(<span class="type">GB2312Encoding</span>)!)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (<span class="type">Alamofire</span>.<span class="type">ParameterEncoding</span>.<span class="type">URL</span>.encode(mutableURLRequest, parameters: <span class="literal">nil</span>).<span class="number">0</span>,uploadData)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">let</span> urlRequest = urlRequestWithComponents(<span class="type">SchoolNetWorkBaseURL</span></span><br><span class="line">, parameters:[<span class="string">"username"</span>:<span class="string">"****"</span>,<span class="string">"credential"</span>:<span class="keyword">self</span>.credential,<span class="string">"logtbl"</span>:<span class="string">"int201607"</span>,<span class="string">"echo"</span>:<span class="string">"查询"</span>,<span class="string">"func"</span>:<span class="string">"计费网关"</span>])</span><br><span class="line"> </span><br><span class="line"><span class="type">Alamofire</span>.upload(urlRequest.<span class="number">0</span>, data: urlRequest.<span class="number">1</span>).response &#123;</span><br><span class="line">    request, response, data, error <span class="keyword">in</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> htmlString:<span class="type">String</span> = <span class="type">NSString</span>(data: data!, encoding: <span class="type">GB2312Encoding</span>)! <span class="keyword">as</span> <span class="type">String</span></span><br><span class="line">    <span class="built_in">print</span>(htmlString)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://huangshuai-iot.github.io/2016/08/02/使用Alamofire实现GB2312编码的网络请求/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄帅">
      <meta itemprop="description" content="说我能做的，做我说过的">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄帅的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/08/02/使用Alamofire实现GB2312编码的网络请求/" class="post-title-link" itemprop="url">Swift 使用 Alamofire 实现 GB2312 编码的网络请求</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-08-02 14:04:58" itemprop="dateCreated datePublished" datetime="2016-08-02T14:04:58+08:00">2016-08-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-16 23:37:13" itemprop="dateModified" datetime="2019-06-16T23:37:13+08:00">2019-06-16</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/开发/" itemprop="url" rel="index"><span itemprop="name">开发</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/开发/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>最近在做一个校园工具，其中有个功能是查看自己校园网账户的剩余流量。学校的网络管理中心没有开放接口，于是只能利用Alamofire来模拟登录解析数据。一开始通过GET请求获取用户账户余额都是没有问题的，但是通过POST请求的话，就无法正确访问数据。</p>
<h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><p>之前知道该网站是GB2312编码的，于是在解析data为HTML的时候就用GB2312解码的。但在POST数据时，也需要GB2312编码。我开始时将post的string参数用GB2312编码，发现不行。于是就查看了Alamofire的源码，发现其默认的参数编码是UTF-8，而且只有这一个选择😂。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> mutableURLRequest.valueForHTTPHeaderField(<span class="string">"Content-Type"</span>) == <span class="literal">nil</span> &#123;</span><br><span class="line">    mutableURLRequest.setValue(<span class="string">"application/x-www-form-urlencoded; charset=utf-8"</span>,forHTTPHeaderField: <span class="string">"Content-Type"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就很尴尬了。在Google搜了半天，也没找到类似的问题。于是问了我一个经常抓包的哥们，他说GB2312编码的服务器遇到的次数非常少。再加上本来用swift模拟请求的场景就不多了，难怪没同样的问题呢。试了很久，我都准备鸣金收兵了。</p>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><p>后来问了学长这个问题，他说可以自定义Alamofire的request，在request中进行参数的GB2312编码或许可以。于是带着最后一丝希望去试了一下，发现学长真行🤗。</p>
<p>自定义Alamofire的request代码如下：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="type">GB2312Encoding</span> = <span class="type">CFStringConvertEncodingToNSStringEncoding</span>(<span class="number">0x0632</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">urlRequestWithComponents</span><span class="params">(urlString:String,parameters:[String: AnyObject])</span></span> -&gt;(<span class="type">URLRequestConvertible</span>,<span class="type">NSData</span>) &#123;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// create  url request to send</span></span><br><span class="line">    <span class="keyword">let</span> mutableURLRequest = <span class="type">NSMutableURLRequest</span>(<span class="type">URL</span>: <span class="type">NSURL</span>(string: urlString)!)</span><br><span class="line">    mutableURLRequest.<span class="type">HTTPMethod</span> = <span class="type">Alamofire</span>.<span class="type">Method</span>.<span class="type">POST</span>.rawValue</span><br><span class="line">    <span class="keyword">let</span> contentType = <span class="string">"application/x-www-form-urlencoded"</span></span><br><span class="line">    mutableURLRequest.setValue(contentType, forHTTPHeaderField: <span class="string">"Content-Type"</span>)</span><br><span class="line">    mutableURLRequest.setValue(<span class="string">"*******"</span>, forHTTPHeaderField: <span class="string">"Referer"</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// add parameters</span></span><br><span class="line">    <span class="keyword">let</span> uploadData = <span class="type">NSMutableData</span>()</span><br><span class="line">    <span class="keyword">for</span> (key,value) <span class="keyword">in</span> parameters &#123;</span><br><span class="line">        uploadData.appendData(<span class="string">"\(key)=\(value)&amp;"</span>.dataUsingEncoding(<span class="type">GB2312Encoding</span>)!)</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> (<span class="type">Alamofire</span>.<span class="type">ParameterEncoding</span>.<span class="type">URL</span>.encode(mutableURLRequest, parameters: <span class="literal">nil</span>).<span class="number">0</span>,uploadData)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用该自定义Request的方法如下：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> urlRequest = urlRequestWithComponents(<span class="type">SchoolNetWorkBaseURL</span>, parameters: parameters)</span><br><span class="line"><span class="type">Alamofire</span>.upload(urlRequest.<span class="number">0</span>, data: urlRequest.<span class="number">1</span>).response &#123;</span><br><span class="line">    request, response, data, error <span class="keyword">in</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过这个，就可以实现使用Alamofire实现GB2312编码的请求了。</p>
<h1 id="番外篇：关于使用Alamofire实现gzip压缩参数的网络请求"><a href="#番外篇：关于使用Alamofire实现gzip压缩参数的网络请求" class="headerlink" title="番外篇：关于使用Alamofire实现gzip压缩参数的网络请求"></a>番外篇：关于使用Alamofire实现gzip压缩参数的网络请求</h1><p>在解决上面的问题时，我一度偏失了方向，以为是参数没有压缩的问题。下面记录一下gzip压缩的参数问题。</p>
<p>下面是对ParameterEncoding的扩展，Alamofire在请求的request的encoding中，选择ParameterEncoding.gzipped即可。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  ParameterEncoding-Extension.swift</span></span><br><span class="line"><span class="comment">//  AHNUer</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Created by 黄帅 on 16/7/28.</span></span><br><span class="line"><span class="comment">//  Copyright © 2016年 帅帅. All rights reserved.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Alamofire</span><br><span class="line"></span><br><span class="line"><span class="comment">// Actual gzipping from https://github.com/1024jp/NSData-GZIP</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Example: ParameterEncoding.JSON.gzipped</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">infix</span> <span class="keyword">operator</span> • &#123; <span class="keyword">associativity</span> <span class="keyword">left</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> • &lt;A, B, C&gt;<span class="params">(f: B -&gt; C, g: A -&gt; B)</span></span> -&gt; <span class="type">A</span> -&gt; <span class="type">C</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; x <span class="keyword">in</span> f(g(x)) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ParameterEncoding</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> gzipped:<span class="type">ParameterEncoding</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> gzip(<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">gzip</span><span class="params">(encoding:ParameterEncoding)</span></span> -&gt; <span class="type">ParameterEncoding</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> gzipEncoding = <span class="keyword">self</span>.gzipOrError • encoding.encode</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="type">ParameterEncoding</span>.<span class="type">Custom</span>(gzipEncoding)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">gzipOrError</span><span class="params">(request:NSURLRequest, error:NSError?)</span></span> -&gt; (<span class="type">NSMutableURLRequest</span>, <span class="type">NSError?</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> mutableRequest = request.mutableCopy() <span class="keyword">as</span>! <span class="type">NSMutableURLRequest</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (mutableRequest, error)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> gzipEncodingError: <span class="type">NSError?</span> = <span class="literal">nil</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> gzippedData = <span class="keyword">try</span> mutableRequest.<span class="type">HTTPBody?</span>.gzippedData()</span><br><span class="line">            mutableRequest.<span class="type">HTTPBody</span> = gzippedData</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> mutableRequest.<span class="type">HTTPBody</span> != <span class="literal">nil</span> &#123;</span><br><span class="line">                mutableRequest.setValue(<span class="string">"gzip"</span>, forHTTPHeaderField: <span class="string">"Content-Encoding"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">            gzipEncodingError = error <span class="keyword">as</span> <span class="type">NSError</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> (mutableRequest, gzipEncodingError)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="http://www.hangge.com/blog/cache/detail_1032.html" target="_blank" rel="noopener">Swift - 使用gzip压缩NSData数据</a></li>
<li><a href="https://gist.github.com/blender/923f1c1de2f00514ed12" target="_blank" rel="noopener">blender/ParameterEncodingExt</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">黄帅</p>
              <div class="site-description motion-element" itemprop="description">说我能做的，做我说过的</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">16</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">8</span>
                    <span class="site-state-item-name">categories</span>
                  
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">29</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">黄帅</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.1.2</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.2"></script>

  <script src="/js/motion.js?v=7.1.2"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.1.2"></script>



  

  


  <script src="/js/next-boot.js?v=7.1.2"></script>


  

  

  

  



  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
